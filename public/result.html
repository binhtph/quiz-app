<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Káº¿t quáº£ - Quiz App</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div class="container">
    <header class="header">
      <h1>
        <a href="/">ğŸ“ Quiz App</a>
      </h1>
    </header>

    <main id="result-container" class="result-container">
      <div class="loading">
        <div class="spinner"></div>
      </div>
    </main>
  </div>

  <script>
    let showMarkedOnly = false;
    let resultData = null;

    function init() {
      const storedData = sessionStorage.getItem('examResult');
      if (!storedData) {
        window.location.href = '/';
        return;
      }

      resultData = JSON.parse(storedData);
      renderResult();

      // Show personal record notification if applicable
      if (resultData.is_new_record) {
        setTimeout(() => {
          if (window.showRecordTicker) {
            window.showRecordTicker(
              `ğŸ‰ ChÃºc má»«ng! Báº¡n Ä‘Ã£ láº­p ká»· lá»¥c má»›i: ${resultData.score}/${resultData.total} (${resultData.percentage}%) - ${resultData.examTitle}`,
              true
            );
          }
        }, 500);
      }
    }

    function renderResult() {
      const result = resultData;
      const container = document.getElementById('result-container');
      const markedIds = result.markedQuestionIds || [];

      // Filter results based on toggle
      const displayResults = showMarkedOnly
        ? result.results.filter(r => markedIds.includes(r.question_id))
        : result.results;

      // Determine score class
      let scoreClass = 'fail';
      let message = 'Cáº§n cá»‘ gáº¯ng thÃªm!';
      if (result.percentage >= 90) {
        scoreClass = 'excellent';
        message = 'Xuáº¥t sáº¯c! ğŸ‰';
      } else if (result.percentage >= 70) {
        scoreClass = 'good';
        message = 'Tá»‘t láº¯m! ğŸ‘';
      } else if (result.percentage >= 50) {
        scoreClass = 'pass';
        message = 'Äáº¡t yÃªu cáº§u';
      }

      // Format time
      const minutes = Math.floor(result.timeTaken / 60);
      const seconds = result.timeTaken % 60;
      const timeStr = `${minutes}:${String(seconds).padStart(2, '0')}`;

      // Get original indices for question numbers
      const getOriginalIndex = (questionId) => {
        return result.results.findIndex(r => r.question_id === questionId);
      };

      container.innerHTML = `
        <h2>${escapeHtml(result.examTitle)}</h2>
        
        <div class="score-circle ${scoreClass}">
          <span class="score-value">${result.percentage}%</span>
          <span class="score-label">${message}</span>
        </div>

        <div class="result-summary">
          <div class="summary-item">
            <div class="value">${result.score}/${result.total}</div>
            <div class="label">Sá»‘ cÃ¢u Ä‘Ãºng</div>
          </div>
          <div class="summary-item">
            <div class="value">${timeStr}</div>
            <div class="label">Thá»i gian</div>
          </div>
        </div>

        <div class="result-actions">
          <a href="/" class="btn btn-secondary">Vá» trang chá»§</a>
          <a href="/exam.html${result.queryParams || ''}" class="btn btn-primary" onclick="sessionStorage.removeItem('examResult')">LÃ m láº¡i</a>
        </div>

        <div class="review-list">
          <div class="review-header">
            <h3>Chi tiáº¿t káº¿t quáº£</h3>
            ${markedIds.length > 0 ? `
              <button class="btn btn-sm ${showMarkedOnly ? 'btn-primary' : 'btn-secondary'}" onclick="toggleMarkedFilter()">
                ğŸš© ${showMarkedOnly ? 'Xem táº¥t cáº£' : `CÃ¢u Ä‘Ã¡nh dáº¥u (${markedIds.length})`}
              </button>
            ` : ''}
          </div>
          
          ${displayResults.length === 0 ? `
            <div class="empty-state" style="padding: 2rem; text-align: center;">
              <p>KhÃ´ng cÃ³ cÃ¢u nÃ o Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u</p>
            </div>
          ` : displayResults.map(r => {
        const originalIndex = getOriginalIndex(r.question_id);
        const isMarked = markedIds.includes(r.question_id);
        return `
            <div class="review-item ${r.is_correct ? 'correct' : 'incorrect'} ${isMarked ? 'marked' : ''}">
              <div class="review-question">
                <strong>CÃ¢u ${originalIndex + 1}:</strong> ${renderContent(r.question)}
                ${isMarked ? '<span class="marked-badge">ğŸš©</span>' : ''}
              </div>
              <div class="review-answers">
                ${r.type === 'drag_drop' ? `
                  <div class="review-answer user">
                    <span>ÄÃ¡p Ã¡n cá»§a báº¡n:</span> ${Array.isArray(r.user_answer) ? r.user_answer.map(renderContent).join(' â†’ ') : 'ChÆ°a tráº£ lá»i'}
                  </div>
                  <div class="review-answer correct">
                    <span>ÄÃ¡p Ã¡n Ä‘Ãºng:</span> ${r.correct_answer.map(renderContent).join(' â†’ ')}
                  </div>
                ` : r.type === 'matching' ? `
                  <div class="review-answer user">
                    <span>ÄÃ¡p Ã¡n cá»§a báº¡n:</span> ${r.user_answer ? Object.entries(r.user_answer).map(([k, v]) => `${renderContent(k)} â†’ ${renderContent(v)}`).join(', ') : 'ChÆ°a tráº£ lá»i'}
                  </div>
                  <div class="review-answer correct">
                    <span>ÄÃ¡p Ã¡n Ä‘Ãºng:</span> ${Object.entries(r.correct_answer).map(([k, v]) => `${renderContent(k)} â†’ ${renderContent(v)}`).join(', ')}
                  </div>
                ` : r.type === 'multiple_choice' ? `
                  <div class="review-answer user">
                    <span>ÄÃ¡p Ã¡n cá»§a báº¡n:</span> ${Array.isArray(r.user_answer) ? r.user_answer.map(renderContent).join(', ') : 'ChÆ°a tráº£ lá»i'}
                    ${r.is_correct ? 'âœ…' : 'âŒ'}
                  </div>
                  ${!r.is_correct ? `
                    <div class="review-answer correct">
                      <span>ÄÃ¡p Ã¡n Ä‘Ãºng:</span> ${r.correct_answer.map(renderContent).join(', ')} âœ…
                    </div>
                  ` : ''}
                ` : `
                  <div class="review-answer user">
                    <span>ÄÃ¡p Ã¡n cá»§a báº¡n:</span> ${r.user_answer ? renderContent(r.user_answer) : 'ChÆ°a tráº£ lá»i'}
                    ${r.is_correct ? 'âœ…' : 'âŒ'}
                  </div>
                  ${!r.is_correct ? `
                    <div class="review-answer correct">
                      <span>ÄÃ¡p Ã¡n Ä‘Ãºng:</span> ${renderContent(r.correct_answer)} âœ…
                    </div>
                  ` : ''}
                `}
              </div>
              ${r.notes ? `
                <div class="review-notes">
                  <strong>ğŸ’¡ Ghi chÃº:</strong> ${renderContent(r.notes)}
                </div>
              ` : ''}
            </div>
          `}).join('')}
        </div>
      `;
    }

    function toggleMarkedFilter() {
      showMarkedOnly = !showMarkedOnly;
      renderResult();
    }

    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function renderContent(text) {
      if (!text) return '';
      if (typeof text !== 'string') return text;
      let html = escapeHtml(text);
      // Replace ![alt](url) with <img src="url" alt="alt" class="content-image">
      html = html.replace(/!\[(.*?)\]\((.*?)\)/g, (match, alt, url) => {
        return `<div class="image-container"><img src="${url}" alt="${alt}" class="content-image"></div>`;
      });
      return html;
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
  <script src="/js/ticker.js"></script>
</body>

</html>